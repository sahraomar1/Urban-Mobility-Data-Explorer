<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Urban Mobility Trackers</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            margin: 0; background-color: #f8f9fa; color: #333; display: flex; height: 100vh;
        }
        .sidebar {
            width: 300px; background-color: #ffffff; padding: 20px; border-right: 1px solid #dee2e6;
            box-shadow: 2px 0 5px rgba(0,0,0,0.05); display: flex; flex-direction: column;
        }
        .main-content {
            flex-grow: 1; padding: 25px; overflow-y: auto;
        }
        .stats-grid {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 20px; margin-bottom: 30px;
        }
        .stat-box {
            background-color: #ffffff; border: 1px solid #dee2e6; padding: 20px;
            border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .stat-box h4 {
            margin: 0 0 10px 0; color: #6c757d; font-size: 14px; font-weight: 500;
        }
        .stat-box p { margin: 0; font-size: 28px; font-weight: bold; color: #0d6efd;}
        .visuals-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .visual-box {
             background-color: #ffffff; border: 1px solid #dee2e6; padding: 20px;
            border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        #map { height: 450px; border-radius: 5px; }
        label { font-weight: bold; font-size: 14px; color: #343a40; }
        input, button {
            width: 100%; padding: 10px; margin-top: 8px; box-sizing: border-box; 
            border: 1px solid #ced4da; border-radius: 4px; font-size: 16px;
        }
        button {
            background-color: #0d6efd; color: white; border: none; cursor: pointer;
            font-weight: bold; transition: background-color 0.2s;
        }
        button:hover { background-color: #0b5ed7; }
    </style>
</head>
<body>

    <div class="sidebar">
        <h2>Dashboard Filters</h2>
        <div style="margin-bottom: 20px;">
            <label for="date-selector">Select a Date</label>
            <input type="date" id="date-selector" disabled>
        </div>
        <hr style="margin: 20px 0;">
        <div>
            <label for="trip-id-search">Search by Trip ID</label>
            <input type="text" id="trip-id-search" placeholder="e.g., id1234567">
            <button id="trip-id-btn">Find Trip</button>
        </div>
    </div>

    <div class="main-content" id="main-content">
        <h1 id="dashboard-title">Urban Mobility Trackers</h1>
        <p id="dashboard-subtitle" style="color: #6c757d;">Loading initial data...</p>

        <div class="stats-grid">
            <div class="stat-box"><h4>Total Trips</h4><p id="stat-trips">--</p></div>
            <div class="stat-box"><h4>Total Passengers</h4><p id="stat-passengers">--</p></div>
            <div class="stat-box"><h4>Avg Trip Duration</h4><p id="stat-duration">--</p></div>
            <div class="stat-box"><h4>Total Distance (km)</h4><p id="stat-distance">--</p></div>
            <div class="stat-box"><h4>Avg Speed (kph)</h4><p id="stat-speed">--</p></div>
            <div class="stat-box"><h4>Busiest Hour</h4><p id="stat-busiest-hour">--</p></div>
        </div>

        <div class="visuals-grid">
            <div class="visual-box">
                <h3>Pickup Locations (Sample)</h3>
                <div id="map"></div>
            </div>
            <div class="visual-box">
                <h3>Trips by Hour</h3>
                <canvas id="tripsByHourChart"></canvas>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const API_BASE_URL = 'http://127.0.0.1:8003';
            const dateSelector = document.getElementById('date-selector');
            const tripIdBtn = document.getElementById('trip-id-btn');
            const subtitle = document.getElementById('dashboard-subtitle');
            let tripsByHourChart, map, mapMarkers;
            
            async function initializeDashboard() {
                try {
                    initializeMap();
                    initializeBarChart();
                    const dateInfo = await fetchData('/dates');
                    dateSelector.min = dateInfo.min_date;
                    dateSelector.max = dateInfo.max_date;
                    dateSelector.value = dateInfo.max_date; 
                    dateSelector.disabled = false;
                    await loadAndDisplayDataForDate(dateInfo.max_date); 
                } catch (error) {
                    subtitle.textContent = `Error: Could not connect to the API. Is it running?`;
                    console.error("Initialization failed:", error);
                }
            }
            
            async function fetchData(endpoint) {
                const response = await fetch(`${API_BASE_URL}${endpoint}`);
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.detail || `API error status ${response.status}`);
                }
                return response.json();
            }

            async function loadAndDisplayDataForDate(date) {
                try {
                    subtitle.textContent = `Fetching data for ${date}...`;
                    const [stats, hourlyData, mapData] = await Promise.all([
                        fetchData(`/stats?date=${date}`),
                        fetchData(`/trips_by_hour?date=${date}`),
                        fetchData(`/map_data?date=${date}`)
                    ]);
                    updateKPIs(stats);
                    updateBarChart(hourlyData);
                    updateMap(mapData);
                    subtitle.textContent = `Showing statistics for ${date}`;
                } catch (error) {
                    subtitle.textContent = `Failed to load data for ${date}.`;
                    console.error("Failed to display data:", error);
                }
            }

            function initializeMap() {
                 map = L.map('map').setView([40.7580, -73.9855], 12);
                 L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '&copy; OSM' }).addTo(map);
                 mapMarkers = L.layerGroup().addTo(map);
            }

            function initializeBarChart() {
                const context = document.getElementById('tripsByHourChart').getContext('2d');
                tripsByHourChart = new Chart(context, {
                    type: 'bar',
                    data: {
                        labels: Array.from({length: 24}, (_, i) => `${i}`),
                        datasets: [{ 
                            label: 'Number of Trips', data: [],
                            backgroundColor: 'rgba(13, 110, 253, 0.5)',
                            borderColor: 'rgba(13, 110, 253, 1)',
                            borderWidth: 1
                        }]
                    },
                    options: { plugins: { legend: { display: false } }, scales: { x: { grid: { display: false } } } }
                });
            }
            
            function updateKPIs(stats) {
                document.getElementById('stat-trips').textContent = Number(stats.total_trips || 0).toLocaleString();
                document.getElementById('stat-passengers').textContent = Number(stats.total_passengers || 0).toLocaleString();
                document.getElementById('stat-duration').textContent = `${Number(stats.avg_trip_duration_mins || 0).toFixed(1)} min`;
                document.getElementById('stat-distance').textContent = Number(stats.total_distance_km || 0).toFixed(1);
                document.getElementById('stat-speed').textContent = `${Number(stats.avg_speed_kph || 0).toFixed(1)}`;
                const busiestHour = stats.busiest_hour;
                document.getElementById('stat-busiest-hour').textContent = busiestHour !== null ? `${busiestHour}:00 - ${busiestHour+1}:00` : '--';
            }

            function updateBarChart(hourlyData) {
                hourlyData.sort((a, b) => a.hour - b.hour);
                tripsByHourChart.data.datasets[0].data = hourlyData.map(item => item.count);
                tripsByHourChart.update();
            }

            function updateMap(mapData) {
                mapMarkers.clearLayers();
                if (mapData.length === 0) return;
                const markers = mapData.map(trip => L.marker([trip.pickup_latitude, trip.pickup_longitude]));
                markers.forEach(marker => mapMarkers.addLayer(marker));
                map.fitBounds(L.featureGroup(markers).getBounds().pad(0.1));
            }
            
            tripIdBtn.addEventListener('click', async () => {
                const tripId = document.getElementById('trip-id-search').value.trim();
                if (!tripId) return; 

                try {
                    const trip = await fetchData(`/trip/${tripId}`);
                    updateMap([trip]);
                    subtitle.textContent = `Displaying data for single Trip ID: ${trip.id}`;
                    dateSelector.value = trip.pickup_datetime.split('T')[0];
                } catch (error) {
                    alert('That Trip ID was not found.');
                }
            });
            
            dateSelector.addEventListener('change', (event) => loadAndDisplayDataForDate(event.target.value));

            initializeDashboard();
        });
    </script>
</body>
</html>